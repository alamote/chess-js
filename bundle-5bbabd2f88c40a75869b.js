(()=>{"use strict";var e,t;!function(e){e.HUMAN="human",e.AI="ai"}(e||(e={}));class i{color;name;type;me=!1;constructor(t,i,s=e.HUMAN,o=!1){this.name=t,this.color=i,this.type=s,this.me=o}}!function(e){e.WHITE="white",e.BLACK="black"}(t||(t={}));const s={white:t.BLACK,black:t.WHITE};var o;!function(e){e.BISHOP="Bishop",e.KING="King",e.KNIGHT="Knight",e.PAWN="Pawn",e.QUEEN="Queen",e.ROOK="Rook"}(o||(o={}));class r{moves=[];add(e){this.moves.push(e),console.log(e.toString())}getMoves(){return this.moves.map((e=>e.toString()))}}class l{player;figure;from;to;timestamp;prevFigure;constructor(e,t,i){this.player=e,this.figure=t.figure,this.from=t,this.to=i,this.timestamp=Date.now(),this.figure&&(this.figure.isMoved=!0),this.prevFigure=i.figure,i.figure=t.figure,t.figure=null}restore(){this.from.figure=this.figure,this.to.figure=this.prevFigure,this.figure.isMoved=!1}toString(){return`${this.player.name}: ${this.figure.figure} ${this.from.coordinates} - ${this.to.coordinates}`}}const a="#352e31",h="#51464a",n="#EED6D3",c="#cebab7",g="#3a3234",u="#2e9a0d",d="#a11a39",f=32,m=400;class w{static circle(e,t,i,s,o={}){e.beginPath(),e.arc(t,i,s,0,2*Math.PI),w.draw(e,o)}static rect(e,t,i,s,o,r={}){e.beginPath(),e.rect(t,i,s,o),w.draw(e,r)}static roundedRect(e,t,i,s,o,r,l={}){e.beginPath(),e.moveTo(t+r,i),e.lineTo(t+s-r,i),e.quadraticCurveTo(t+s,i,t+s,i+r),e.lineTo(t+s,i+o-r),e.quadraticCurveTo(t+s,i+o,t+s-r,i+o),e.lineTo(t+r,i+o),e.quadraticCurveTo(t,i+o,t,i+o-r),e.lineTo(t,i+r),e.quadraticCurveTo(t,i,t+r,i),e.closePath(),w.draw(e,l)}static text(e,t,i,s,o={}){o.stroke||o.fill||(o.stroke=!0),o.line_width&&(e.lineWidth=2),o.text_align&&(e.textAlign=o.text_align),o.text_valign&&(e.textBaseline=o.text_valign),o.font&&(e.font=o.font),o.line_color&&(e.strokeStyle=o.line_color),o.shadow_blur&&(e.shadowBlur=o.shadow_blur,o.shadow_color&&(e.shadowColor=o.shadow_color)),o.stroke&&e.strokeText(t,i,s),o.fill&&e.fillText(t,i,s),w.reset(e)}static preloadedImage(e,t,i,s,o,r,l={}){l.shadow_blur&&(e.shadowBlur=l.shadow_blur,l.shadow_color&&(e.shadowColor=l.shadow_color)),e.drawImage(r,t,i,s,o),w.reset(e)}static image(e,t,i,s,o,r,l={},a=(()=>null)){const h=new Image(s,o);l.shadow_blur&&(e.shadowBlur=l.shadow_blur,l.shadow_color&&(e.shadowColor=l.shadow_color)),h.onload=()=>{e.drawImage(h,t,i,s,o),w.reset(e),a()},h.src=r}static draw(e,t={}){t.line_width&&(e.lineWidth=t.line_width),t.stroke&&(t.line_color&&(e.strokeStyle=t.line_color),e.stroke()),t.fill&&(t.fill_color&&(e.fillStyle=t.fill_color),e.fill()),t.shadow_blur&&(e.shadowBlur=t.shadow_blur,t.shadow_color&&(e.shadowColor=t.shadow_color)),w.reset(e)}static reset(e){e.shadowBlur=0,e.shadowColor="transparent",e.strokeStyle="black",e.fillStyle="black",e.lineWidth=1}}class v{static boardSize(){let e=Math.max(m,Math.min(window.innerWidth,window.innerHeight));return e-=e/10,e%8!=0&&(e=8*Math.floor(e/8)),e}static cellSize(){return(v.boardSize()-2*f)/8-2.3}static rowToLetter(e){return String.fromCharCode(64+e)}}class p{game;context;size;color;image;row;column;state={has_figure:!0,is_highlighted:!1,is_active:!1,is_movable:!1,is_checked:!1,has_moves:!1,move_figure:null};constructor(e,t,i,s){this.color=this.getColorByRowAndColumn(e,t),this.row=e,this.column=t,this.size=v.cellSize(),this.context=i,this.game=s,this.image=new Image(this.size,this.size),this.image.src=`assets/images/cell_bg_${Math.floor(8*Math.random())+1}.png`}_figure;get figure(){return this._figure}set figure(e){this._figure=e,this.state.has_figure=!!e}get x(){return this.size*this.column+2*this.column+2+f}get y(){return this.size*Math.abs(this.row-7)+2*Math.abs(this.row-7)+2+f}get cellColor(){return this.state.is_highlighted?this.color===t.BLACK?h:c:this.state.is_checked?d:this.state.is_active?u:this.color===t.BLACK?a:n}get coordinates(){return`${this.rowToLetter}${this.column+1}`}get rowToLetter(){return String.fromCharCode(65+this.row)}get isChecked(){return!!this.figure&&this.game.board.getCellsByColor(s[this.figure.color]).some((e=>{const t=e.getCheckMove;if(t){const i=this.game.board.getCell(e.row+t.row,e.column+t.column);return i?.row===this.row&&i?.column===this.column}return!1}))}get getMoves(){return this.figure?.moves.filter((e=>e.isValid(this.game,this)))??[]}get hasMoves(){return!!this.getMoves.length}get getCheckMove(){return this.figure?.moves.find((e=>e.isCheckMove(this.game,this)))??null}getColorByRowAndColumn(e,i){return(e+1)%2&&(i+1)%2||!((e+1)%2||(i+1)%2)?t.BLACK:t.WHITE}showMoves(){this.getMoves.forEach((e=>{const t=this.game.board.getCell(this.row+e.row,this.column+e.column);t&&(t.state.is_movable=!0,t.state.move_figure=this.figure?.image??null)}))}render(){w.rect(this.context,this.x,this.y,this.size,this.size,{fill:!0,fill_color:this.cellColor,stroke:!0,line_color:g,line_width:2}),w.preloadedImage(this.context,this.x,this.y,this.size,this.size,this.image),this.figure?.image&&(w.preloadedImage(this.context,this.x,this.y,this.size,this.size,this.figure.image),this.state.is_movable&&(w.circle(this.context,this.x+this.size/2,this.y+this.size/2,this.size/4,{fill:!0,fill_color:d}),this.state.move_figure&&w.preloadedImage(this.context,this.x+this.size/3,this.y+this.size/3,this.size/3,this.size/3,this.state.move_figure))),this.game.board.transformCell||(this.state.is_movable&&!this.figure&&(w.circle(this.context,this.x+this.size/2,this.y+this.size/2,this.size/4,{fill:!0,fill_color:u}),this.state.move_figure&&w.preloadedImage(this.context,this.x+this.size/3,this.y+this.size/3,this.size/3,this.size/3,this.state.move_figure)),this.game.activePlayer.type===e.HUMAN&&this.state.has_moves&&w.rect(this.context,this.x,this.y+this.size-this.size/20,this.size,this.size/20,{fill:!0,fill_color:u}))}}class _{color;multiplier=1;figure;image;state={is_highlighted:!1};moves=[];isMoved=!1;constructor(e){this.color=e,this.multiplier=e===t.WHITE?1:-1}setFigure(e){this.figure=e,this.image=new Image(v.cellSize(),v.cellSize()),this.image.src=`assets/icons/figures/${this.color}/${this.figure.toLowerCase()}.svg`}}class y{row;column;conditions=[];conditionCallbacks={isBlack:(e,i)=>i?.figure?.color===t.BLACK,isWhite:(e,i)=>i?.figure?.color===t.WHITE,isNotOwn:(e,t)=>!this.getTarget(e,t)?.figure||t.figure?.color!==this.getTarget(e,t)?.figure?.color,isEnemy:(e,t)=>!!this.getTarget(e,t)?.figure&&t.figure?.color!==this.getTarget(e,t)?.figure?.color,isEmpty:(e,t)=>!this.getTarget(e,t)?.figure,isNotEmpty:(e,t)=>!!this.getTarget(e,t)?.figure,isMoved:(e,t)=>!!t?.figure?.isMoved,isNotMoved:(e,t)=>!t?.figure?.isMoved,isCellExists:(e,t)=>!!this.getTarget(e,t),isVerticalPathEmpty:(e,t)=>Array(Math.abs(this.row)-1).fill(0).every(((i,s)=>!e.board.getCell(t.row+(s+1)*(this.row>0?1:-1),t.column)?.figure)),isHorizontalPathEmpty:(e,t)=>Array(Math.abs(this.column)-1).fill(0).every(((i,s)=>!e.board.getCell(t.row,t.column+(s+1)*(this.column>0?1:-1))?.figure)),isDiagonalPathEmpty:(e,t)=>Array(Math.abs(this.row)-1).fill(0).every(((i,s)=>!e.board.getCell(t.row+(s+1)*(this.row>0?1:-1),t.column+(s+1)*(this.column>0?1:-1))?.figure)),isKing:(e,t)=>this.getTarget(e,t)?.figure instanceof z,isNotKing:(e,t)=>!(this.getTarget(e,t)?.figure instanceof z),isNotNearKing:(e,t)=>{const i=this.getTarget(e,t);if(!i)return!1;for(let s=-1;s<=1;s++)for(let o=-1;o<=1;o++){const r=e.board.getCell(i.row+s,i.column+o)?.figure;if(r instanceof z&&r.color!==t.figure?.color)return!1}return!0}};constructor(e,t,i=[],s=!0){this.row=e,this.column=t,this.conditions=i,s&&(this.conditions.includes("isCellExists")||this.conditions.push("isCellExists"),this.conditions.includes("isNotOwn")||this.conditions.push("isNotOwn"),this.conditions.includes("isNotKing")||this.conditions.push("isNotKing"))}getTarget(e,t){return e.board.getCell(t.row+this.row,t.column+this.column)}isValid(e,t){return this.conditions.every((i=>this.conditionCallbacks[i](e,t)))&&this.isPreventsCheck(e,t)}isPreventsCheck(e,t){if(!this.getTarget(e,t))return!0;let i=!0;const s=new l(e.activePlayer,t,this.getTarget(e,t));return e.board.getCellByFigureAndColor(o.KING,e.activePlayer.color).isChecked&&(i=!1),s.restore(),i}isCheckMove(e,t){const i=this.getTarget(e,t);return!!i&&!!this.conditions.filter((e=>!["isNotKing","isNotOwn"].includes(e))).every((i=>this.conditionCallbacks[i](e,t)))&&i.figure instanceof z&&i.figure.color!==t.figure?.color}}class z extends _{constructor(e){super(e),this.setFigure(o.KING),this.moves=[new y(1,1,["isNotNearKing"]),new y(1,0,["isNotNearKing"]),new y(1,-1,["isNotNearKing"]),new y(0,1,["isNotNearKing"]),new y(0,-1,["isNotNearKing"]),new y(-1,1,["isNotNearKing"]),new y(-1,0,["isNotNearKing"]),new y(-1,-1,["isNotNearKing"])]}}class C extends _{constructor(e){super(e),this.setFigure(o.PAWN),this.moves=[new y(2,0,["isNotMoved","isVerticalPathEmpty","isEmpty","isWhite"]),new y(1,0,["isEmpty","isWhite"]),new y(1,-1,["isEnemy","isWhite"]),new y(1,1,["isEnemy","isWhite"]),new y(-2,0,["isNotMoved","isVerticalPathEmpty","isEmpty","isBlack"]),new y(-1,0,["isEmpty","isBlack"]),new y(-1,-1,["isEnemy","isBlack"]),new y(-1,1,["isEnemy","isBlack"])]}}class b extends _{constructor(e){super(e),this.setFigure(o.BISHOP);for(let e=1;e<8;e++)this.moves.push(new y(e,e,["isDiagonalPathEmpty"])),this.moves.push(new y(e,-e,["isDiagonalPathEmpty"])),this.moves.push(new y(-e,e,["isDiagonalPathEmpty"])),this.moves.push(new y(-e,-e,["isDiagonalPathEmpty"]))}}class x extends _{constructor(e){super(e),this.setFigure(o.QUEEN);for(let e=1;e<8;e++)this.moves.push(new y(e,e,["isDiagonalPathEmpty"])),this.moves.push(new y(e,-e,["isDiagonalPathEmpty"])),this.moves.push(new y(-e,e,["isDiagonalPathEmpty"])),this.moves.push(new y(-e,-e,["isDiagonalPathEmpty"])),this.moves.push(new y(e,0,["isVerticalPathEmpty"])),this.moves.push(new y(-e,0,["isVerticalPathEmpty"])),this.moves.push(new y(0,e,["isHorizontalPathEmpty"])),this.moves.push(new y(0,-e,["isHorizontalPathEmpty"]))}}class E extends _{constructor(e){super(e),this.setFigure(o.KNIGHT),this.moves=[new y(2,1,["isNotOwn"]),new y(2,-1,["isNotOwn"]),new y(-2,1,["isNotOwn"]),new y(-2,-1,["isNotOwn"]),new y(1,2,["isNotOwn"]),new y(1,-2,["isNotOwn"]),new y(-1,2,["isNotOwn"]),new y(-1,-2,["isNotOwn"])]}}class S extends _{constructor(e){super(e),this.setFigure(o.ROOK);for(let e=1;e<8;e++)this.moves.push(new y(e,0,["isVerticalPathEmpty"])),this.moves.push(new y(-e,0,["isVerticalPathEmpty"])),this.moves.push(new y(0,e,["isHorizontalPathEmpty"])),this.moves.push(new y(0,-e,["isHorizontalPathEmpty"]))}}class M{game;canvas;context;size;cells=[];state={size:v.boardSize()};prevState;constructor(e){this.game=e,this.canvas=document.querySelector("canvas.board"),this.context=this.canvas.getContext("2d");for(let t=0;t<8;t++)for(let i=0;i<8;i++)this.cells.push(new p(t,i,this.context,e))}get transformCell(){const e={[t.WHITE]:7,[t.BLACK]:0};return this.cells.find((t=>t.figure&&t.figure instanceof C&&t.row===e[t.figure.color]))??null}setBoardSize(){this.size!==v.boardSize()&&(this.size=v.boardSize(),this.state.size=this.size,this.cells.forEach((e=>e.size=v.cellSize())),this.canvas&&(this.canvas.width=this.size,this.canvas.height=this.size))}getCell(e,t){return this.cells.find((i=>i.row===e&&i.column===t))}getCellByXAndY(e,t){return this.cells.find((i=>e>=i.x&&e<=i.x+i.size&&t>=i.y&&t<=i.y+i.size))}getCellsByColor(e){return this.cells.filter((t=>t.figure&&t.figure.color===e))}getCellByFigureAndColor(e,t){return this.cells.find((i=>i.figure&&i.figure.figure===e&&i.figure.color===t))}processCheck(){Object.values(t).forEach((e=>{const t=this.getCellByFigureAndColor(o.KING,e);t.state.is_checked=t.isChecked}))}reset(){this.setBoardSize(),this.cells.forEach((e=>e.figure=null)),[0,7].forEach((e=>{const i=e?t.BLACK:t.WHITE;this.getCell(e,0).figure=new S(i),this.getCell(e,1).figure=new E(i),this.getCell(e,2).figure=new b(i),this.getCell(e,3).figure=new x(i),this.getCell(e,4).figure=new z(i),this.getCell(e,5).figure=new b(i),this.getCell(e,6).figure=new E(i),this.getCell(e,7).figure=new S(i)})),[1,6].forEach((e=>{for(let i=0;i<8;i++)this.getCell(e,i).figure=new C(1===e?t.WHITE:t.BLACK)})),this.cells.forEach((e=>e.state.has_moves=this.game.activePlayer.color===e.figure?.color&&e?.hasMoves)),this.processCheck(),this.game.activePlayer.type===e.AI&&setTimeout((()=>this.game.autoMove()),100),requestAnimationFrame((()=>this.render()))}render(e=!1){const i={line_width:2,text_align:"center",text_valign:"middle",font:"18px Arial",line_color:n};if(e||!this.prevState||JSON.stringify(this.state)!==JSON.stringify(this.prevState)){this.prevState={...this.state},w.rect(this.context,1,1,this.size-2,this.size-2,{stroke:!0,line_color:g,line_width:2,fill:!0,fill_color:a});const e=this.cells[0].size;for(let t=1;t<=8;t++)w.text(this.context,t.toString(),(t-1)*e+e/2+f+2.3*(t-1)+3,f/2+2,i),w.text(this.context,t.toString(),(t-1)*e+e/2+f+2.3*(t-1)+3,this.size-f/2-2,i),w.text(this.context,String.fromCharCode(64+t),f/2,Math.abs(t-8)*e+e/2+f+2.6*Math.abs(t-8),i),w.text(this.context,String.fromCharCode(64+t),this.size-f/2,Math.abs(t-8)*e+e/2+f+2.6*Math.abs(t-8),i)}if(this.cells.forEach((e=>e.render())),this.transformCell){const e=v.cellSize()+32,i=5*v.cellSize();w.rect(this.context,this.size/2-i/2,this.size/2-e/2,i,e,{stroke:!0,line_color:g,line_width:2,fill:!0,fill_color:n}),w.text(this.context,"Select new figure:",this.size/2,this.size/2-e/2+16,{line_width:2,text_align:"center",text_valign:"middle",font:"bold 16px Poppins",line_color:a,fill:!0});const s=this.transformCell.figure?.color??t.WHITE;[new C(s),new S(s),new E(s),new b(s),new x(s)].forEach(((t,s)=>{const o=this.size/2-i/2+v.cellSize()*s,r=this.size/2-e/2+24;w.preloadedImage(this.context,o,r,v.cellSize(),v.cellSize(),t.image)}))}if(!this.game.hasMoves()){const e={line_width:5,text_align:"center",text_valign:"middle",font:`bold ${this.size/10}px Poppins`,line_color:a,fill_color:a,shadow_color:n,shadow_blur:20,fill:!0};w.text(this.context,"Game over!",this.size/2,this.size/2-this.size/15,e),w.text(this.context,this.cells.find((e=>e.isChecked))?`${this.game.oppositePlayer.name} won :)`:"Stalemate :(",this.size/2,this.size/2+this.size/15,e)}this.game.transformWindow&&this.game.transformWindow.render(),requestAnimationFrame((()=>this.render()))}}class P{game;figures=[];constructor(e,t){this.game=e,this.figures=[new S(t),new E(t),new b(t),new x(t)]}getTransformFigureByXAndY(e,t){const i=v.cellSize()+2*f,s=v.cellSize()*this.figures.length+f;return this.figures.find(((o,r)=>{const l=v.boardSize()/2-s/2+v.cellSize()*r+f/2,a=v.boardSize()/2-i/2+1.5*f;return e>=l&&e<=l+v.cellSize()&&t>=a&&t<=a+v.cellSize()}))??null}render(){const e=v.cellSize()+2*f,t=v.cellSize()*this.figures.length+f;w.roundedRect(this.game.board.context,v.boardSize()/2-t/2,v.boardSize()/2-e/2,t,e,6,{stroke:!0,line_color:g,line_width:2,fill:!0,fill_color:n}),w.text(this.game.board.context,"Select new figure:",v.boardSize()/2,v.boardSize()/2-e/2+f,{line_width:2,text_align:"center",text_valign:"middle",font:`bold ${v.cellSize()/6}px Poppins`,line_color:a,fill:!0}),this.figures.forEach(((i,s)=>{const o=v.boardSize()/2-t/2+v.cellSize()*s+f/2,r=v.boardSize()/2-e/2+1.5*f;w.preloadedImage(this.game.board.context,o,r,v.cellSize(),v.cellSize(),i.image),i.state.is_highlighted&&w.roundedRect(this.game.board.context,o,r,v.cellSize(),v.cellSize(),6,{stroke:!0,line_color:g,line_width:2})}))}}class N{board;transformWindow;log=new r;players=[];activePlayer;timeout=100;constructor(){const s=class{static getQuery(){const e=window.location.search.substring(1),t={};return e.split("&").forEach((e=>{const[i,s]=e.split("=");t[i]=s})),t}}.getQuery(),o=s.mode?.toLowerCase()??"pvp";this.timeout=s.timeout?+s.timeout:100,this.players.push(new i("Sergey",t.WHITE,o.startsWith("p")?e.HUMAN:e.AI,!0)),this.players.push(new i("Vet",t.BLACK,o.endsWith("p")?e.HUMAN:e.AI)),this.changePlayer(),this.board=new M(this),this.board.reset(),this.activePlayer.color!==this.me.color&&setTimeout((()=>this.autoMove()),this.timeout)}get me(){return this.players.find((e=>e.me))}get activeCell(){return this.board.cells.find((e=>e.state.is_active))??null}get oppositePlayer(){return this.activePlayer===this.players[0]?this.players[1]:this.players[0]}hasMoves(){return!!this.board.cells.find((e=>this.activePlayer.color===e.figure?.color&&e?.hasMoves))}move(t,i,s){this.board.cells.forEach((e=>e.state.is_checked=!1));const o=new l(t,i,s);if(this.log.add(o),this.board.transformCell)return this.transformWindow=new P(this,this.board.transformCell.figure?.color),void(this.activePlayer.type===e.AI&&(this.board.transformCell.figure=this.transformWindow.figures[Math.floor(Math.random()*this.transformWindow.figures.length)],this.transformWindow=null,this.updateBoard()));this.updateBoard()}updateBoard(){this.board.processCheck(),this.changePlayer(),this.board.cells.forEach((e=>e.state.is_movable=!1)),this.board.cells.forEach((e=>e.state.has_moves=this.activePlayer.color===e.figure?.color&&e?.hasMoves)),this.hasMoves()&&this.activePlayer.type===e.AI&&setTimeout((()=>this.autoMove()),this.timeout)}changePlayer(){this.activePlayer=this.oppositePlayer}onClick(e){if(this.transformWindow&&this.board.transformCell){const t=this.transformWindow.getTransformFigureByXAndY(e.offsetX,e.offsetY);t&&(this.board.transformCell.figure=t,this.transformWindow=null,this.updateBoard())}else{const t=this.board.getCellByXAndY(e.offsetX,e.offsetY);if(t?.state.is_movable&&this.activeCell&&this.move(this.activePlayer,this.activeCell,t),this.board.cells.forEach((e=>e.state.is_movable=!1)),t?.state.is_active)return void(t.state.is_active=!1);this.board.cells.forEach((e=>e.state.is_active=!1)),t?.figure&&t?.state.has_moves&&(t.state.is_active=!0,t.showMoves())}}onMouseLeave(){this.board.cells.forEach((e=>e.state.is_highlighted=!1))}onMouseMove(e){if(this.board.cells.forEach((e=>e.state.is_highlighted=!1)),this.transformWindow){this.transformWindow.figures.forEach((e=>e.state.is_highlighted=!1));const t=this.transformWindow.getTransformFigureByXAndY(e.offsetX,e.offsetY);return t&&(t.state.is_highlighted=!0),!!t}const t=this.board.getCellByXAndY(e.offsetX,e.offsetY);return(t?.state.has_moves||t?.state.is_movable)&&(t.state.is_highlighted=!0),!!t?.state.is_highlighted}autoMove(){const e=this.board.cells.filter((e=>e.state.has_moves&&e.state.has_figure));if(e.length){const t=e[Math.floor(Math.random()*e.length)];t.state.is_active=!0,t.showMoves();const i=this.board.cells.filter((e=>e.state.is_movable));if(i.length){const e=i[Math.floor(Math.random()*i.length)];this.move(this.activePlayer,t,e),t.state.is_active=!1}}}}document.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelector(".board"),t=new N;document.addEventListener("click",(e=>t.onClick(e))),window.addEventListener("resize",(()=>t.board.setBoardSize())),e&&(e.addEventListener("mousemove",(i=>{t.onMouseMove(i)?e.classList.add("pointer"):e.classList.remove("pointer")})),e.addEventListener("mouseout",(()=>t.onMouseLeave())))}))})();